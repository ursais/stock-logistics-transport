<?xml version="1.0" encoding="UTF-8" ?>
<odoo>
    <record id="view_tms_travel_search" model="ir.ui.view">
        <field name="name">tms.travel.search</field>
        <field name="model">tms.travel</field>
        <field name="arch" type="xml">
            <search>
                <filter name="draft" domain="[('state','=','draft')]" string="Draft" />
                <filter name="scheduled" domain="[('state','=','scheduled')]" string="Scheduled" />
                <filter name="progress" domain="[('state','=','progress')]" string="In Progress" />
                <filter name="done" domain="[('state','=','done')]" string="Done" />
                <filter name="closed" domain="[('state','=','closed')]" string="Closed" />
                <filter name="cancelled" domain="[('state','=','cancel')]" string="Cancelled" />
                <field name="name" />
                <field name="unit_id" string="Unit" />
                <field name="driver_id" />
                <field name="route_id" />
                <field name="trailer1_id" />
                <field name="dolly_id" />
                <field name="trailer2_id" />
                <field name="date_start" />
                <field name="date_end" />
                <field name="partner_ids" />
                <filter name="unit" context="{'group_by' : 'unit_id'}" string="Unit" />
                <filter name="driver" context="{'group_by' : 'driver_id'}" string="Driver" />
                <filter name="stage" context="{'group_by' : 'stage_id'}" string="Stage" />
                <filter
                    name="company"
                    groups="base.group_multi_company"
                    context="{'group_by' : 'company_id'}"
                    string="Company"
                />
                <filter name="state" context="{'group_by' : 'state'}" string="State" />
                <filter name="create_date" context="{'group_by' : 'create_date'}" string="Create Date" />
                <filter context="{'group_by' : 'date_start_real'}" name="date_dispatched" string="Day Dispatched" />
                <filter name="day_finished" context="{'group_by' : 'date_end_real'}" string="Day Finished" />
            </search>
        </field>
    </record>
    <record id="view_tms_travel_tree" model="ir.ui.view">
        <field name="name">tms.travel.tree</field>
        <field name="model">tms.travel</field>
        <field name="priority">1</field>
        <field name="arch" type="xml">
            <tree
                decoration-muted="state=='cancel'"
                decoration-danger="error_message"
                decoration-success="state=='progress'"
                decoration-info="state=='done'"
            >
                <field name="error_message" invisible="1" />
                <field name="name" />
                <field name="partner_ids" widget="many2many_tags" />
                <field name="driver_id" optional="show" />
                <field name="unit_id" optional="show" />
                <field name="trailer1_id" optional="hide" />
                <field name="dolly_id" optional="hide" />
                <field name="trailer2_id" optional="hide" />
                <field name="waybill_ids" widget="many2many_tags" />
                <field name="route_id" optional="show" />
                <field name="company_id" groups="base.group_multi_company" optional="hide" />
                <field
                    name="state"
                    widget="badge"
                    decoration-info="state == 'scheduled'"
                    decoration-success="state == 'progress'"
                    decoration-muted="state == 'done'"
                    decoration-warning="state == 'closed'"
                    decoration-danger="state == 'cancel'"
                />
                <button
                    groups="tms.group_tms_traffic,tms.group_tms_expenses"
                    icon="fa-calendar"
                    name="action_schedule"
                    attrs="{'invisible': ['|', ('error_message', '!=', False), ('state', '!=', 'draft')]}"
                    string="Schedule"
                    type="object"
                />
                <button
                    groups="tms.group_tms_traffic,tms.group_tms_expenses"
                    icon="fa-thumbs-up"
                    name="action_progress"
                    attrs="{'invisible': ['|', ('error_message', '!=', False), ('state', '!=', 'scheduled')]}"
                    string="Dispatch Travel"
                    type="object"
                />
                <button
                    groups="tms.group_tms_traffic,tms.group_tms_expenses"
                    icon="fa-check-square"
                    name="action_done"
                    attrs="{'invisible': ['|', ('error_message', '!=', False), ('state', '!=', 'progress')]}"
                    string="End Travel"
                    type="object"
                />
            </tree>
        </field>
    </record>
    <record id="tms_travel_view_gantt" model="ir.ui.view">
        <field name="name">tms.travel.view.gantt</field>
        <field name="model">tms.travel</field>
        <field name="arch" type="xml">
            <gantt
                string="Travels"
                date_start="date_start"
                date_stop="date_end"
                create="0"
                delete="0"
                color="stage_id"
                default_group_by="unit_id"
                decoration-danger="error_message"
                decoration-secondary="state == 'done'"
                decoration-info="state == 'scheduled'"
                decoration-success="state == 'progress'"
                decoration-warning="state == 'cancel'"
            >
                <field name="error_message" />
                <field name="state" />
                <field name="driver_id" />
                <field name="unit_id" />
                <field name="route_id" />
                <field name="stage_id" />
                <templates>
                    <div t-name="gantt-popover" class="container-fluid">
                        <div class="row no-gutters">
                            <div class="col">
                                <ul class="pl-1 mb-0 list-unstyled">
                                    <li><strong>Driver: </strong> <t t-esc="driver_id[1]" /></li>
                                    <li><strong>Unit: </strong> <t t-esc="unit_id[1]" /></li>
                                    <li><strong>Route: </strong> <t t-esc="route_id[1]" /></li>
                                    <li><strong>Date Start: </strong> <t
                                            t-esc="userTimezoneStartDate.format('L LTS')"
                                        /></li>
                                    <li><strong>Date End: </strong> <t
                                            t-esc="userTimezoneStopDate.format('L LTS')"
                                        /></li>
                                    <li><strong>Stage: </strong> <t t-esc="stage_id[1]" /></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </templates>
            </gantt>
        </field>
    </record>
    <record id="view_tms_travel_form" model="ir.ui.view">
        <field name="name">tms.travel.form</field>
        <field name="model">tms.travel</field>
        <field name="arch" type="xml">
            <form string="Travels">
                <header>
                    <button
                        name="action_schedule"
                        icon="fa-calendar"
                        type="object"
                        string="Schedule"
                        attrs="{'invisible': ['|', ('error_message', '!=', False), ('state', '!=', 'draft')]}"
                        groups="tms.group_tms_traffic,tms.group_tms_expenses"
                        class="oe_highlight"
                    />
                    <button
                        name="action_progress"
                        icon="fa-thumbs-up"
                        type="object"
                        string="Dispatch"
                        attrs="{'invisible': ['|', ('error_message', '!=', False), ('state', '!=', 'scheduled')]}"
                        groups="tms.group_tms_traffic,tms.group_tms_expenses"
                        class="oe_highlight"
                    />
                    <button
                        name="action_done"
                        icon="fa-check-square"
                        type="object"
                        string="Finish"
                        states="progress"
                        groups="tms.group_tms_traffic,tms.group_tms_expenses"
                        class="oe_highlight"
                    />
                    <button
                        name="action_cancel"
                        icon="fa-times"
                        type="object"
                        string="Cancel"
                        states="draft,progress"
                        groups="tms.group_tms_traffic,tms.group_tms_expenses"
                    />
                    <button
                        name="action_draft"
                        icon="fa-reply"
                        type="object"
                        string="Set to draft"
                        states="scheduled,cancel"
                        groups="tms.group_tms_traffic,tms.group_tms_expenses"
                    />
                    <field name="stage_id" widget="statusbar" options="{'clickable': '1', 'fold_field': 'fold'}" />
                </header>
                <div
                    class="alert alert-danger mb-0"
                    role="alert"
                    attrs="{'invisible': [('error_message', '=', False)]}"
                >
                    <field name="error_message" />
                </div>
                <sheet>
                    <widget
                        name="web_ribbon"
                        bg_color="bg-muted"
                        title="Draft"
                        attrs="{'invisible': [('state', '!=', 'draft')]}"
                    />
                    <widget
                        name="web_ribbon"
                        bg_color="bg-info"
                        title="Scheduled"
                        attrs="{'invisible': [('state', '!=', 'scheduled')]}"
                    />
                    <widget
                        name="web_ribbon"
                        bg_color="bg-success"
                        title="In Progress"
                        attrs="{'invisible': [('state', '!=', 'progress')]}"
                    />
                    <widget
                        name="web_ribbon"
                        bg_color="bg-danger"
                        title="Cancelled"
                        attrs="{'invisible': [('state', '!=', 'cancel')]}"
                    />
                    <widget
                        name="web_ribbon"
                        bg_color="bg-secondary"
                        title="Done"
                        attrs="{'invisible': [('state', '!=', 'done')]}"
                    />
                    <widget
                        name="web_ribbon"
                        bg_color="bg-secondary"
                        title="Closed"
                        attrs="{'invisible': [('state', '!=', 'closed')]}"
                    />
                    <field name="state" invisible="1" />
                    <div class="oe_title">
                        <span class="o_form_label">Travel</span>
                        <h1 class="mt0">
                            <field name="name" />
                        </h1>
                    </div>
                    <group>
                        <group string="Driver and Units" name="driver_and_units">
                            <field
                                name="kit_id"
                                attrs="{'readonly':[('state', '!=', 'draft')]}"
                                options="{'no_create': 1}"
                            />
                            <field
                                name="driver_id"
                                options="{'no_create': 1}"
                                attrs="{'readonly':[('state', '!=', 'draft')]}"
                            />
                            <field
                                name="unit_id"
                                options="{'no_create': 1}"
                                attrs="{'readonly':[('state', '!=', 'draft')]}"
                                domain="[('fleet_type', '=', 'tractor')]"
                            />
                            <field
                                name="trailer1_id"
                                options="{'no_create': 1}"
                                attrs="{'required':['|', ('dolly_id','!=',False),('trailer2_id','!=',False)], 'readonly':[('state', '!=', 'draft')]}"
                                context="{'default_fleet_type': 'trailer'}"
                                domain="[('fleet_type', '=', 'trailer'),('id','!=',trailer2_id)]"
                            />
                            <field
                                name="dolly_id"
                                options="{'no_create': 1}"
                                attrs="{'required':[('trailer2_id','!=',False)],'readonly':[('state', '!=', 'draft')]}"
                                context="{'default_fleet_type': 'dolly'}"
                                domain="[('fleet_type', '=', 'dolly')]"
                            />
                            <field
                                name="trailer2_id"
                                options="{'no_create': 1}"
                                attrs="{'required':[('dolly_id','!=',False)],'readonly':[('state', '!=', 'draft')]}"
                                context="{'default_fleet_type': 'trailer'}"
                                domain="[('fleet_type', '=', 'trailer'),('id','!=',trailer1_id)]"
                            />
                        </group>
                        <group string="Date and Times" name="date_and_times">
                            <label for="date_start" string="Scheduled date" />
                            <div class="o_row">
                                <field
                                    name="date_start"
                                    widget="daterange"
                                    attrs="{'readonly':[('state', '!=', 'draft')]}"
                                    options="{'related_end_date': 'date_end'}"
                                />
                                <i class="fa fa-long-arrow-right mx-1" aria-label="Arrow icon" title="Arrow" />
                                <field
                                    name="date_end"
                                    widget="daterange"
                                    attrs="{'readonly':[('state', '!=', 'draft')]}"
                                    options="{'related_start_date': 'date_start'}"
                                />
                            </div>
                            <label
                                for="date_start_real"
                                string="Real date"
                                attrs="{'invisible': [('date_start_real', '=', False)]}"
                            />
                            <div class="o_row" attrs="{'invisible': [('date_start_real', '=', False)]}">
                                <field
                                    name="date_start_real"
                                    widget="daterange"
                                    options="{'related_end_date': 'date_end_real'}"
                                />
                                <i
                                    class="fa fa-long-arrow-right mx-1"
                                    aria-label="Arrow icon"
                                    title="Arrow"
                                    attrs="{'invisible': [('date_end_real', '=', False)]}"
                                />
                                <field
                                    name="date_end_real"
                                    widget="daterange"
                                    attrs="{'invisible': [('date_end_real', '=', False)]}"
                                    options="{'related_start_date': 'date_start_real'}"
                                />
                            </div>
                            <field
                                name="route_travel_time"
                                widget="float_time"
                                force_save="1"
                                attrs="{'invisible': [('travel_time_real', '>', 0)]}"
                            />
                            <label
                                for="route_travel_time"
                                string="Duration Sched / Duration Real"
                                attrs="{'invisible': [('travel_time_real', '=', 0)]}"
                            />
                            <div class="o_row" attrs="{'invisible': [('travel_time_real', '=', 0)]}">
                                <field name="route_travel_time" force_save="1" widget="float_time" />
                                <label for="travel_time_real" string=" / " />
                                <field name="travel_time_real" widget="float_time" />
                            </div>
                            <field
                                name="user_id"
                                options="{'no_create': 1, 'no_open': 1}"
                                attrs="{'readonly':[('state', '!=', 'draft')]}"
                            />
                            <field
                                name="company_id"
                                groups="base.group_multi_company"
                                options="{'no_create': 1, 'no_open': 1}"
                                attrs="{'readonly':[('state', '!=', 'draft')]}"
                            />
                        </group>
                    </group>
                    <group string="Route" name="route">
                        <group>
                            <field
                                name="partner_ids"
                                widget="many2many_tags"
                                options="{'no_create': 1}"
                                attrs="{'readonly':[('state', '!=', 'draft')]}"
                            />
                            <field
                                name="route_id"
                                options="{'no_create': 1}"
                                attrs="{'readonly':[('state', '!=', 'draft')]}"
                                domain="[('partner_ids', 'in', partner_ids)]"
                            />
                        </group>
                    </group>
                    <notebook>
                        <page string="Vehicle log fuel">
                            <field
                                name="fuel_ids"
                                attrs="{'readonly':[('state', 'in', ['done', 'closed'])]}"
                                nolabel="1"
                            >
                              <tree
                                    decoration-info="state=='draft'"
                                    decoration-success="state=='confirmed'"
                                    decoration-muted="state=='closed'"
                                    decoration-danger="state=='cancel'"
                                    editable="bottom"
                                >
                                    <field name="name" />
                                    <field name="date" />
                                    <field name="ref" />
                                    <field name="partner_id" />
                                    <field name="product_id" options="{'no_create': 1}" />
                                    <field name="product_qty" />
                                    <field name="product_uom_id" options="{'no_create': 1}" optional="hide" />
                                    <field name="price_unit" optional="hide" />
                                    <field name="currency_id" optional="hide" groups="base.group_multi_currency" />
                                    <field
                                        name="tax_ids"
                                        widget="many2many_tags"
                                        optional="hide"
                                        options="{'no_create': 1}"
                                    />
                                    <field name="amount_untaxed" optional="hide" />
                                    <field name="tax_amount" />
                                    <field name="amount_total" />
                                    <field
                                        name="payment_state"
                                        widget="badge"
                                        decoration-danger="payment_state == 'not_paid'"
                                        decoration-warning="payment_state in ('partial', 'in_payment')"
                                        decoration-success="payment_state in ('paid', 'reversed')"
                                    />
                                    <field
                                        name="state"
                                        widget="badge"
                                        decoration-info="state=='draft'"
                                        decoration-success="state=='confirmed'"
                                        decoration-muted="state=='closed'"
                                        decoration-danger="state=='cancel'"
                                    />
                                    <button
                                        class="oe_highlight"
                                        icon="fa-check-square-o"
                                        name="action_confirm"
                                        states="draft"
                                        string="Confirmed"
                                        type="object"
                                    />
                                </tree>
                            </field>
                        </page>
                        <page string="Advances">
                            <field name="advance_ids" attrs="{'readonly':[('state', 'in', ['done', 'closed'])]}">
                                <tree
                                    decoration-muted="state=='closed'"
                                    decoration-success="state=='confirmed'"
                                    decoration-info="state=='done'"
                                    decoration-danger="state=='cancel'"
                                    editable="bottom"
                                >
                                    <field name="name" readonly="1" />
                                    <field name="product_id" options="{'no_create': 1}" />
                                    <field name="amount" sum="Amount Total" />
                                    <field name="currency_id" optional="hide" />
                                    <field name="auto_expense" widget="boolean_toggle" />
                                    <field
                                        name="payment_state"
                                        widget="badge"
                                        decoration-danger="payment_state == 'not_paid'"
                                        decoration-warning="payment_state == 'partial'"
                                        decoration-success="payment_state == 'paid'"
                                        optional="show"
                                    />
                                    <field name="state" optional="show" />
                                    <button
                                        icon="fa-arrow-right"
                                        name="action_confirm"
                                        states="draft"
                                        string="Confirmed"
                                        type="object"
                                    />
                                </tree>
                            </field>
                        </page>
                        <page string="Waybills">
                            <group>
                                <field
                                    name="waybill_ids"
                                    attrs="{'readonly':[('state', 'in', ['done', 'closed'])]}"
                                    nolabel="1"
                                />
                            </group>
                        </page>
                        <page string="Statistics">
                            <group>
                                <group string="Route Distances (mi./kms)">
                                    <label for="route_distance_loaded" />
                                    <div class="o_row">
                                        <field name="route_distance_loaded" force_save="1" />
                                        <field name="odometer_unit" />
                                    </div>
                                    <label for="route_distance_empty" />
                                    <div class="o_row">
                                        <field name="route_distance_empty" force_save="1" />
                                        <field name="odometer_unit" />
                                    </div>
                                    <label for="route_distance" />
                                    <div class="o_row">
                                        <field name="route_distance" force_save="1" />
                                        <field name="odometer_unit" />
                                    </div>
                                </group>
                                <group string="Real Distances">
                                    <label for="distance_loaded" />
                                    <div class="o_row">
                                        <field
                                            name="distance_loaded"
                                            attrs="{'readonly': [('state', '!=', 'progress')]}"
                                        />
                                        <field name="odometer_unit" />
                                    </div>
                                    <label for="distance_empty" />
                                    <div class="o_row">
                                        <field
                                            name="distance_empty"
                                            attrs="{'readonly': [('state', '!=', 'progress')]}"
                                        />
                                        <field name="odometer_unit" />
                                    </div>
                                    <label for="distance" />
                                    <div class="o_row">
                                        <field name="distance" />
                                        <field name="odometer_unit" />
                                    </div>
                                    <label for="odometer" attrs="{'invisible': [('odometer', '=', 0)]}" />
                                    <div class="o_row" attrs="{'invisible': [('odometer', '=', 0)]}">
                                        <field name="odometer" />
                                        <field name="odometer_unit" />
                                    </div>
                                </group>
                            </group>
                        </page>
                    </notebook>
                </sheet>
                <div class="oe_chatter">
                    <field name="message_follower_ids" widget="mail_followers" />
                    <field name="activity_ids" widget="mail_activity" />
                    <field name="message_ids" widget="mail_thread" />
                </div>
            </form>
        </field>
    </record>
    <record id="view_tms_travel_calendar" model="ir.ui.view">
        <field name="name">tms.travel.calendar</field>
        <field name="model">tms.travel</field>
        <field name="arch" type="xml">
            <calendar color="state" date_start="date_start" date_stop="date_end" string="Travels">
                <field name="name" />
                <field name="unit_id" options="{'no_open': 1}" />
                <field name="driver_id" options="{'no_open': 1}" />
                <field name="route_id" options="{'no_open': 1}" />
                <field name="date_start" />
                <field name="date_end" />
            </calendar>
        </field>
    </record>
    <record id="tms_travel_view_kanban" model="ir.ui.view">
        <field name="name">tms.travel.view.kanban</field>
        <field name="model">tms.travel</field>
        <field name="arch" type="xml">
            <kanban default_group_by="stage_id">
                <field name="name" />
                <field name="date_start" />
                <field name="date_end" />
                <field name="unit_id" />
                <field name="driver_id" />
                <field name="route_id" />
                <field
                    name="state"
                    widget="badge"
                    decoration-info="state == 'scheduled'"
                    decoration-success="state == 'progress'"
                    decoration-muted="state == 'done'"
                    decoration-warning="state == 'closed'"
                    decoration-danger="state == 'cancel'"
                />
                <field name="error_message" />
                <templates>
                    <t t-name="kanban-box">
                        <div t-attf-class="oe_kanban_global_click">
                            <div class="row mb4">
                                <div class="col-12 o_kanban_record_headings">
                                    <strong>
                                        <span>
                                            <field name="name" />
                                        </span>
                                    </strong>
                                    <div t-if="record.error_message.value" class="float-right">
                                        <a
                                            role="button"
                                            class="badge badge-danger"
                                            data-toggle="dropdown"
                                            data-display="static"
                                            href="#"
                                            aria-label="Errors"
                                            title="Errors"
                                        >Errors</a>
                                        <div class="dropdown-menu" role="menu">
                                            <div class="container">
                                                <t t-esc="record.error_message.value" />
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-12">
                                    <strong>
                                        <t t-esc="record.date_start.value" />
                                        <i class="fa fa-long-arrow-right mx-1" aria-label="Arrow icon" title="Arrow" />
                                        <t t-esc="record.date_end.value" />
                                    </strong><br />
                                    <span><field name="unit_id" /></span><br />
                                    <span><field name="driver_id" widget="many2one_avatar_employee" /><t
                                            t-esc="record.driver_id.value"
                                        /></span><br />
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-6">
                                    <span><b>Route:</b><br /><field name="route_id" /></span>
                                </div>
                                <div class="col-6">
                                    <span class="float-right">
                                        <field name="activity_ids" widget="kanban_activity" />
                                        <field
                                            name="state"
                                            widget="label_selection"
                                            options="{
                                                'classes': {
                                                    'draft': 'muted',
                                                    'scheduled': 'info',
                                                    'progress': 'success',
                                                    'done': 'secondary',
                                                    'closed': 'warning',
                                                    'cancel': 'danger',
                                                }
                                            }"
                                        />
                                    </span>
                                </div>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>
    <record id="open_view_tms_travel_form" model="ir.actions.act_window">
        <field name="name">Travel</field>
        <field name="res_model">tms.travel</field>
        <field name="view_mode">tree,form,kanban,gantt,calendar</field>
    </record>
</odoo>
