<?xml version="1.0" encoding="UTF-8" ?>
<odoo>
    <record id="view_tms_travel_search" model="ir.ui.view">
        <field name="name">tms.travel.search</field>
        <field name="model">tms.travel</field>
        <field name="arch" type="xml">
            <search>
                <filter name="draft" domain="[('state','=','draft')]" string="Draft" />
                <filter name="scheduled" domain="[('state','=','scheduled')]" string="Scheduled" />
                <filter name="progress" domain="[('state','=','progress')]" string="In Progress" />
                <filter name="done" domain="[('state','=','done')]" string="Done" />
                <filter name="closed" domain="[('state','=','closed')]" string="Closed" />
                <filter name="cancelled" domain="[('state','=','cancel')]" string="Cancelled" />
                <field name="name" />
                <field name="unit_id" string="Unit" />
                <field name="driver_id" />
                <field name="route_id" />
                <field name="trailer1_id" />
                <field name="dolly_id" />
                <field name="trailer2_id" />
                <field name="date_start" />
                <field name="date_end" />
                <filter name="unit" context="{'group_by' : 'unit_id'}" string="Unit" />
                <filter name="driver" context="{'group_by' : 'driver_id'}" string="Driver" />
                <filter
                    name="company"
                    groups="base.group_multi_company"
                    context="{'group_by' : 'company_id'}"
                    string="Company"
                />
                <filter name="state" context="{'group_by' : 'state'}" string="State" />
                <filter name="create_date" context="{'group_by' : 'create_date'}" string="Create Date" />
                <filter context="{'group_by' : 'date_start_real'}" name="date_dispatched" string="Day Dispatched" />
                <filter name="day_finished" context="{'group_by' : 'date_end_real'}" string="Day Finished" />
            </search>
        </field>
    </record>
    <record id="view_tms_travel_tree" model="ir.ui.view">
        <field name="name">tms.travel.tree</field>
        <field name="model">tms.travel</field>
        <field name="priority">1</field>
        <field name="arch" type="xml">
            <tree
                decoration-muted="state=='cancel'"
                decoration-danger="error_message"
                decoration-success="state=='progress'"
                decoration-info="state=='done'"
            >
                <field name="error_message" invisible="1" />
                <field name="name" />
                <field name="driver_id" optional="show" />
                <field name="unit_id" optional="show" />
                <field name="trailer1_id" optional="hide" />
                <field name="dolly_id" optional="hide" />
                <field name="trailer2_id" optional="hide" />
                <!-- <field name="waybill_ids" widget="many2many_tags" /> -->
                <field name="route_id" optional="show" />
                <field name="company_id" groups="base.group_multi_company" optional="hide" />
                <field name="state" />
                <button
                    groups="tms.group_tms_traffic,tms.group_tms_expenses"
                    icon="fa-calendar"
                    name="action_schedule"
                    attrs="{'invisible': ['|', ('error_message', '!=', False), ('state', '!=', 'draft')]}"
                    string="Schedule"
                    type="object"
                />
                <button
                    groups="tms.group_tms_traffic,tms.group_tms_expenses"
                    icon="fa-thumbs-up"
                    name="action_progress"
                    attrs="{'invisible': ['|', ('error_message', '!=', False), ('state', '!=', 'scheduled')]}"
                    string="Dispatch Travel"
                    type="object"
                />
                <button
                    groups="tms.group_tms_traffic,tms.group_tms_expenses"
                    icon="fa-check-square"
                    name="action_done"
                    attrs="{'invisible': ['|', ('error_message', '!=', False), ('state', '!=', 'progress')]}"
                    string="End Travel"
                    type="object"
                />
            </tree>
        </field>
    </record>
    <record id="view_tms_travel_tree_report" model="ir.ui.view">
        <field name="name">tms.travel.tree</field>
        <field name="model">tms.travel</field>
        <field name="priority">2</field>
        <field name="arch" type="xml">
            <tree
                decoration-muted="state=='cancel'"
                decoration-danger="error_message"
                decoration-success="state=='progress'"
                decoration-info="state=='done'"
            >
                <field name="error_message" invisible="1" />
                <field name="name" />
                <field name="create_date" />
                <field name="unit_id" string="Unit" />
                <field name="trailer1_id" />
                <field name="dolly_id" />
                <field name="trailer2_id" />
                <field name="driver_id" />
                <field name="company_id" groups="base.group_multi_company" />
                <!-- <field name="partner_ids" widget="many2many_tags" />
                <field name="waybill_ids" widget="many2many_tags" /> -->
                <field name="state" />
            </tree>
        </field>
    </record>
    <record id="view_tms_travel_tree_customer" model="ir.ui.view">
        <field name="name">tms.travel.tree</field>
        <field name="model">tms.travel</field>
        <field name="priority">99</field>
        <field name="arch" type="xml">
            <tree
                decoration-muted="state=='cancel'"
                decoration-danger="state=='draft'"
                decoration-success="state=='progress'"
                decoration-info="state=='done'"
            >
                <field name="name" />
                <field name="create_date" />
                <field name="unit_id" string="Unit" />
                <field name="trailer1_id" />
                <field name="dolly_id" />
                <field name="trailer2_id" />
                <field name="driver_id" />
                <!-- <field name="partner_ids" widget="many2many_tags" />
                <field name="waybill_ids" widget="many2many_tags" /> -->
                <field name="route_id" />
                <field name="company_id" groups="base.group_multi_company" />
                <field name="state" />
            </tree>
        </field>
    </record>
    <record id="view_tms_travel_graph" model="ir.ui.view">
        <field name="name">tms.travel.graph</field>
        <field name="model">tms.travel</field>
        <field name="arch" type="xml">
            <graph string="Travels" type="bar">
                <field name="unit_id" />
            </graph>
        </field>
    </record>
    <record id="tms_travel_view_gantt" model="ir.ui.view">
        <field name="name">tms.travel.view.gantt</field>
        <field name="model">tms.travel</field>
        <field name="arch" type="xml">
            <gantt
                string="Travels"
                date_start="date_start"
                date_stop="date_end"
                create="0"
                delete="0"
                color="state"
                default_group_by="unit_id"
                decoration-danger="error_message"
                decoration-secondary="state == 'done'"
                decoration-info="state == 'scheduled'"
                decoration-success="state == 'progress'"
                decoration-warning="state == 'cancel'"
            >
                <field name="error_message" />
                <field name="state" />
                <field name="driver_id" />
                <field name="unit_id" />
                <field name="route_id" />
                <templates>
                    <div t-name="gantt-popover" class="container-fluid">
                        <div class="row no-gutters">
                            <div class="col">
                                <ul class="pl-1 mb-0 list-unstyled">
                                    <li><strong>Driver: </strong> <t t-esc="driver_id[1]" /></li>
                                    <li><strong>Unit: </strong> <t t-esc="unit_id[1]" /></li>
                                    <li><strong>Route: </strong> <t t-esc="route_id[1]" /></li>
                                    <li><strong>Date Start: </strong> <t
                                            t-esc="userTimezoneStartDate.format('L LTS')"
                                        /></li>
                                    <li><strong>Date End: </strong> <t
                                            t-esc="userTimezoneStopDate.format('L LTS')"
                                        /></li>
                                    <li><strong>State: </strong> <t t-esc="state" /></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </templates>
            </gantt>
        </field>
    </record>
    <record id="view_tms_travel_form" model="ir.ui.view">
        <field name="name">tms.travel.form</field>
        <field name="model">tms.travel</field>
        <field name="arch" type="xml">
            <form string="Travels">
                <header>
                    <button
                        name="action_schedule"
                        icon="fa-calendar"
                        type="object"
                        string="Schedule"
                        attrs="{'invisible': ['|', ('error_message', '!=', False), ('state', '!=', 'draft')]}"
                        groups="tms.group_tms_traffic,tms.group_tms_expenses"
                        class="oe_highlight"
                    />
                    <button
                        name="action_progress"
                        icon="fa-thumbs-up"
                        type="object"
                        string="Dispatch"
                        attrs="{'invisible': ['|', ('error_message', '!=', False), ('state', '!=', 'scheduled')]}"
                        groups="tms.group_tms_traffic,tms.group_tms_expenses"
                        class="oe_highlight"
                    />
                    <button
                        name="action_done"
                        icon="fa-check-square"
                        type="object"
                        string="Finish"
                        states="progress"
                        groups="tms.group_tms_traffic,tms.group_tms_expenses"
                        class="oe_highlight"
                    />
                    <button
                        name="action_cancel"
                        icon="fa-times"
                        type="object"
                        string="Cancel"
                        states="draft,progress"
                        groups="tms.group_tms_traffic,tms.group_tms_expenses"
                    />
                    <button
                        name="action_draft"
                        icon="fa-reply"
                        type="object"
                        string="Set to draft"
                        states="scheduled,cancel"
                        groups="tms.group_tms_traffic,tms.group_tms_expenses"
                    />
                    <field name="state" widget="statusbar" />
                </header>
                <div
                    class="alert alert-danger mb-0"
                    role="alert"
                    attrs="{'invisible': [('error_message', '=', False)]}"
                >
                    <field name="error_message" />
                </div>
                <sheet>
                    <div class="oe_title">
                        <span class="o_form_label">Travel</span>
                        <h1 class="mt0">
                            <field name="name" />
                        </h1>
                    </div>
                    <group>
                        <group string="Driver and Units" name="driver_and_units">
                            <field
                                name="kit_id"
                                attrs="{'readonly':[('state', '!=', 'draft')]}"
                                options="{'no_create': 1}"
                            />
                            <field
                                name="driver_id"
                                options="{'no_create': 1}"
                                attrs="{'readonly':[('state', '!=', 'draft')]}"
                            />
                            <field
                                name="unit_id"
                                options="{'no_create': 1}"
                                attrs="{'readonly':[('state', '!=', 'draft')]}"
                                domain="[('fleet_type', '=', 'tractor')]"
                            />
                            <field
                                name="trailer1_id"
                                options="{'no_create': 1}"
                                attrs="{'required':['|', ('dolly_id','!=',False),('trailer2_id','!=',False)], 'readonly':[('state', '!=', 'draft')]}"
                                context="{'default_fleet_type': 'trailer'}"
                                domain="[('fleet_type', '=', 'trailer'),('id','!=',trailer2_id)]"
                            />
                            <field
                                name="dolly_id"
                                options="{'no_create': 1}"
                                attrs="{'required':[('trailer2_id','!=',False)],'readonly':[('state', '!=', 'draft')]}"
                                context="{'default_fleet_type': 'dolly'}"
                                domain="[('fleet_type', '=', 'dolly')]"
                            />
                            <field
                                name="trailer2_id"
                                options="{'no_create': 1}"
                                attrs="{'required':[('dolly_id','!=',False)],'readonly':[('state', '!=', 'draft')]}"
                                context="{'default_fleet_type': 'trailer'}"
                                domain="[('fleet_type', '=', 'trailer'),('id','!=',trailer1_id)]"
                            />
                        </group>
                        <group string="Date and Times" name="date_and_times">
                            <label for="date_start" string="Scheduled date" />
                            <div class="o_row">
                                <field
                                    name="date_start"
                                    widget="daterange"
                                    attrs="{'readonly':[('state', '!=', 'draft')]}"
                                    options="{'related_end_date': 'date_end'}"
                                />
                                <i class="fa fa-long-arrow-right mx-1" aria-label="Arrow icon" title="Arrow" />
                                <field
                                    name="date_end"
                                    widget="daterange"
                                    attrs="{'readonly':[('state', '!=', 'draft')]}"
                                    options="{'related_start_date': 'date_start'}"
                                />
                            </div>
                            <label
                                for="date_start_real"
                                string="Real date"
                                attrs="{'invisible': [('date_start_real', '=', False)]}"
                            />
                            <div class="o_row" attrs="{'invisible': [('date_start_real', '=', False)]}">
                                <field
                                    name="date_start_real"
                                    widget="daterange"
                                    options="{'related_end_date': 'date_end_real'}"
                                />
                                <i
                                    class="fa fa-long-arrow-right mx-1"
                                    aria-label="Arrow icon"
                                    title="Arrow"
                                    attrs="{'invisible': [('date_end_real', '=', False)]}"
                                />
                                <field
                                    name="date_end_real"
                                    widget="daterange"
                                    attrs="{'invisible': [('date_end_real', '=', False)]}"
                                    options="{'related_start_date': 'date_start_real'}"
                                />
                            </div>
                            <field
                                name="route_travel_time"
                                widget="float_time"
                                attrs="{'invisible': [('travel_time_real', '>', 0)]}"
                            />
                            <label
                                for="route_travel_time"
                                string="Duration Sched / Duration Real"
                                attrs="{'invisible': [('travel_time_real', '=', 0)]}"
                            />
                            <div class="o_row" attrs="{'invisible': [('travel_time_real', '=', 0)]}">
                                <field name="route_travel_time" widget="float_time" />
                                <label for="travel_time_real" string=" / " />
                                <field name="travel_time_real" widget="float_time" />
                            </div>
                            <field
                                name="user_id"
                                options="{'no_create': 1, 'no_open': 1}"
                                attrs="{'readonly':[('state', '!=', 'draft')]}"
                            />
                            <field
                                name="company_id"
                                groups="base.group_multi_company"
                                options="{'no_create': 1, 'no_open': 1}"
                                attrs="{'readonly':[('state', '!=', 'draft')]}"
                            />
                        </group>
                    </group>
                    <group string="Route" name="route">
                        <field
                            name="route_id"
                            options="{'no_create': 1}"
                            attrs="{'readonly':[('state', '!=', 'draft')]}"
                        />
                    </group>
                    <notebook>
                        <!--<page string="Vehicle log fuel">
                            <field
                                name="fuel_log_ids"
                                attrs="{'readonly':[('state', 'in', ['done', 'closed'])]}"
                                nolabel="1"
                                context="{
                                'default_travel_id':active_id,
                                'default_operating_unit_id':operating_unit_id,
                                'default_vehicle_id': unit_id,
                            }"
                            >
                              <tree
                                    decoration-danger="state=='cancel'"
                                    decoration-success="state=='approved'"
                                    decoration-info="state=='confirmed'"
                                    editable="bottom"
                                >
                                    <field name="name" readonly="1" />
                                    <field name="vendor_id" />
                                    <field name="product_qty" />
                                    <field name="price_unit" optional="hide" />
                                    <field name="price_subtotal" optional="hide" />
                                    <field name="tax_amount" />
                                    <field name="special_tax_amount" optional="hide" />
                                    <field name="price_total" />
                                    <field name="state" />
                                </tree>
                            </field>
                        </page>
                        <page string="Advances">
                            <field name="advance_ids" attrs="{'readonly':[('state', 'in', ['done', 'closed'])]}">
                                <tree
                                    decoration-danger="state=='cancel'"
                                    decoration-success="state=='approved'"
                                    decoration-info="state=='confirmed'"
                                    editable="bottom"
                                >
                                    <field name="name" readonly="1" />
                                    <field name="product_id" />
                                    <field name="amount" widget='monetary' sum="Amount Total" />
                                    <field name="currency_id" optional="hide" />
                                    <field name="auto_expense" />
                                    <field name="paid" optional="hide" />
                                    <field name="notes" optional="hide" />
                                    <field name="state" optional="show" />
                                    <button
                                        icon="fa-arrow-right"
                                        name="action_approve"
                                        states="draft"
                                        string="Approve"
                                        type="object"
                                    />
                                    <button
                                        icon="fa-arrow-right"
                                        name="action_authorized"
                                        states="authorized"
                                        string="To Authorize"
                                        type="object"
                                    />
                                    <button
                                        icon="fa-check"
                                        name="action_confirm"
                                        states="approved"
                                        string="Confirm"
                                        type="object"
                                    />
                                </tree>
                            </field>
                        </page>
                        <page string="Waybills">
                            <group>
                                <field
                                    name="waybill_ids"
                                    attrs="{'readonly':[('state', 'in', ['done', 'closed'])]}"
                                    nolabel="1"
                                >
                                    <tree
                                        decoration-danger="state=='cancel'"
                                        decoration-success="state=='approved'"
                                        decoration-info="state=='confirmed'"
                                    >
                                        <button
                                            icon="gtk-go-forward"
                                            name="action_approve"
                                            states="draft"
                                            string="Approve"
                                            type="object"
                                        />
                                        <button
                                            icon="gtk-ok"
                                            name="action_confirm"
                                            states="approved"
                                            string="Confirm"
                                            type="object"
                                        />
                                        <field name="state" />
                                        <field name="name" />
                                        <field name="date_order" />
                                        <field name="partner_id" />
                                        <field name="product_qty" sum="Product Quantity" />
                                        <field name="amount_untaxed" sum="Amount Untaxed" />
                                        <field name="amount_tax" sum="Taxes" />
                                        <field name="amount_total" sum="Total " />
                                    </tree>
                                </field>
                            </group>
                        </page>-->
                        <page string="Statistics">
                            <group>
                                <group string="Route Distances (mi./kms)">
                                    <label for="route_distance_loaded" />
                                    <div class="o_row">
                                        <field name="route_distance_loaded" />
                                        <field name="odometer_unit" />
                                    </div>
                                    <label for="route_distance_empty" />
                                    <div class="o_row">
                                        <field name="route_distance_empty" />
                                        <field name="odometer_unit" />
                                    </div>
                                    <label for="route_distance" />
                                    <div class="o_row">
                                        <field name="route_distance" />
                                        <field name="odometer_unit" />
                                    </div>
                                </group>
                                <group string="Real Distances">
                                    <label
                                        for="distance_loaded"
                                        attrs="{'readonly':[('state', 'in', ['done', 'closed'])]}"
                                    />
                                    <div class="o_row" attrs="{'readonly':[('state', 'in', ['done', 'closed'])]}">
                                        <field name="distance_loaded" />
                                        <field name="odometer_unit" />
                                    </div>
                                    <label
                                        for="distance_empty"
                                        attrs="{'readonly':[('state', 'in', ['done', 'closed'])]}"
                                    />
                                    <div class="o_row" attrs="{'readonly':[('state', 'in', ['done', 'closed'])]}">
                                        <field name="distance_empty" />
                                        <field name="odometer_unit" />
                                    </div>
                                    <label for="distance" />
                                    <div class="o_row">
                                        <field name="distance" />
                                        <field name="odometer_unit" />
                                    </div>
                                    <label for="odometer" attrs="{'invisible': [('odometer', '=', 0)]}" />
                                    <div class="o_row" attrs="{'invisible': [('odometer', '=', 0)]}">
                                        <field name="odometer" />
                                        <field name="odometer_unit" />
                                    </div>
                                </group>
                            </group>
                        </page>
                    </notebook>
                </sheet>
                <div class="oe_chatter">
                    <field name="message_follower_ids" widget="mail_followers" />
                    <field name="activity_ids" widget="mail_activity" />
                    <field name="message_ids" widget="mail_thread" />
                </div>
            </form>
        </field>
    </record>
    <record id="view_tms_travel_form_expense" model="ir.ui.view">
        <field name="name">tms.travel.expense.form</field>
        <field name="model">tms.travel</field>
        <field name="priority" eval="20" />
        <field name="arch" type="xml">
            <form string="Travels">
                <header>
                    <field name="state" widget="statusbar" />
                </header>
                <sheet>
                    <div class="oe_title">
                        <h1>
                            <label
                                for="name"
                                class="oe_inline"
                                style="font-size:30px;"
                                string="Travel - "
                                attrs="{'invisible':[('name','=', False)]}"
                            />
                            <field name="name" readonly="1" />
                        </h1>
                    </div>
                    <group>
                        <group>
                            <field
                                name="kit_id"
                                attrs="{'readonly':[('state', '!=', 'draft')]}"
                                options="{'no_create': 1, 'no_create_edit': 1}"
                            />
                            <field
                                name="unit_id"
                                attrs="{'readonly':[('state', '!=', 'draft')]}"
                                domain="[('fleet_type', '=', 'tractor')]"
                            />
                            <field
                                name="trailer1_id"
                                attrs="{'required':['|', ('dolly_id','!=',False),('trailer2_id','!=',False)], 'readonly':[('state', '!=', 'draft')]}"
                                context="{'default_fleet_type': 'trailer'}"
                                domain="[('fleet_type', '=', 'trailer'),('id','!=',trailer2_id)]"
                            />
                            <field
                                name="dolly_id"
                                attrs="{'required':[('trailer2_id','!=',False)],'readonly':[('state', '!=', 'draft')]}"
                                context="{'default_fleet_type': 'dolly'}"
                                domain="[('fleet_type', '=', 'dolly')]"
                            />
                            <field
                                name="trailer2_id"
                                attrs="{'required':[('dolly_id','!=',False)],'readonly':[('state', '!=', 'draft')]}"
                                context="{'default_fleet_type': 'trailer'}"
                                domain="[('fleet_type', '=', 'trailer'),('id','!=',trailer1_id)]"
                            />
                        </group>
                        <group>
                            <field name="user_id" attrs="{'readonly':[('state', '!=', 'draft')]}" />
                            <field name="driver_id" attrs="{'readonly':[('state', '!=', 'draft')]}" />
                            <field name="company_id" groups="base.group_multi_company" />
                        </group>
                        <group colspan="4">
                            <field name="route_id" attrs="{'readonly':[('state', '!=', 'draft')]}" />
                        </group>
                    </group>
                    <!-- <notebook colspan="4">
                        <page string="Expense driver factor">
                            <field name="driver_factor_ids" context="{'default_category': 'driver'}" />
                        </page>
                        <page string="Waybills">
                            <group>
                                <field
                                    name="waybill_ids"
                                    nolabel="1"
                                    context="{'form_view_ref': 'tms.view_tms_waybill_form_expense'}"
                                >
                                    <tree create="false">
                                        <field name="name" />
                                        <field name="date_order" />
                                        <field name="partner_id" />
                                        <field name="amount_untaxed" />
                                        <field name="amount_tax" />
                                        <field name="amount_total" />
                                    </tree>
                                </field>
                            </group>
                        </page>
                    </notebook> -->
                </sheet>
            </form>
        </field>
    </record>
    <record id="view_tms_travel_calendar" model="ir.ui.view">
        <field name="name">tms.travel.calendar</field>
        <field name="model">tms.travel</field>
        <field name="arch" type="xml">
            <calendar color="state" date_start="date_start" date_stop="date_end" string="Travels">
                <field name="name" />
                <field name="unit_id" options="{'no_open': 1}" />
                <field name="driver_id" options="{'no_open': 1}" />
                <field name="route_id" options="{'no_open': 1}" />
                <field name="date_start" />
                <field name="date_end" />
            </calendar>
        </field>
    </record>

    <!-- Action for tms.travel -->
    <record id="open_view_tms_travel_form" model="ir.actions.act_window">
        <field name="name">Travel</field>
        <field name="res_model">tms.travel</field>
        <field name="view_mode">tree,form,kanban,gantt,calendar,graph</field>
    </record>
    <record id="open_view_tms_travel_report" model="ir.actions.act_window">
        <field name="name">Travel Report</field>
        <field name="res_model">tms.travel</field>
        <field name="view_mode">tree,form</field>
        <field name="view_id" ref="view_tms_travel_tree_report" />
        <field name="context">{'search_default_progress':1, 'search_default_date_dispatched': 1}</field>
    </record>
</odoo>
