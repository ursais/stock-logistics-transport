<?xml version="1.0" encoding="utf-8" ?>
<odoo>
    <record id="view_tms_waybill_tree" model="ir.ui.view">
        <field name="name">tms.waybill.tree</field>
        <field name="model">tms.waybill</field>
        <field name="priority">2</field>
        <field name="arch" type="xml">
            <tree
                decoration-muted="state=='closed'"
                decoration-danger="state=='cancel'"
                decoration-info="state=='draft'"
                decoration-success="state=='confirmed'"
            >
                <header>
                    <button name="action_invoice" string="Create Invoice" type="object" />
                </header>
                <field name="name" />
                <field name="date" />
                <field name="partner_id" />
                <field name="amount_untaxed" sum="Amount Untaxed" />
                <field name="amount_tax" />
                <field name="amount_total" />
                <field
                    name="payment_state"
                    widget="badge"
                    decoration-danger="payment_state == 'not_paid'"
                    decoration-warning="payment_state in ('partial', 'in_payment')"
                    decoration-success="payment_state in ('paid', 'reversed')"
                />
                <field name="state" />
                <button icon="fa-check-square-o" name="action_confirm" states="draft" string="Confirm" type="object" />
            </tree>
        </field>
    </record>
    <record id="view_tms_waybill_form" model="ir.ui.view">
        <field name="name">tms.waybill.form</field>
        <field name="model">tms.waybill</field>
        <field name="arch" type="xml">
            <form string="Waybill">
                <header>
                    <button
                        class="oe_highlight"
                        icon="fa-check-square-o"
                        name="action_confirm"
                        states="draft"
                        string="Confirm"
                        type="object"
                    />
                    <button name="compute_waybill_lines" string="Compute Lines" type="object" states="draft" />
                    <button
                        class="oe_highlight"
                        name="action_invoice"
                        string="Create Invoice"
                        type="object"
                        attrs="{'invisible': ['|', ('state', '!=', 'confirmed'), ('move_id', '!=', False)]}"
                    />
                    <button
                        icon="fa-reply"
                        name="action_cancel_draft"
                        states="cancel"
                        string="Set to Draft"
                        type="object"
                    />
                    <button
                        icon="fa-times"
                        name="action_cancel"
                        states="draft,confirmed"
                        string="Cancel"
                        type="object"
                    />
                    <field name="state" statusbar_visible="draft,confirmed" widget="statusbar" />

                </header>
                <sheet>
                    <div class="oe_button_box" name="button_box">
                        <field name="move_id" invisible="1" />
                        <button
                            name="action_view_invoice"
                            type="object"
                            class="oe_stat_button"
                            icon="fa-pencil-square-o"
                            attrs="{'invisible': [('move_id', '=', False)]}"
                        >
                            <div class="o_field_widget o_stat_info">
                                <span class="o_stat_text">View Invoice</span>
                            </div>
                        </button>
                    </div>
                    <widget name="web_ribbon" title="Paid" attrs="{'invisible': [('payment_state', '!=', 'paid')]}" />
                    <widget
                        name="web_ribbon"
                        title="Partial"
                        bg_color="bg-warning"
                        attrs="{'invisible': [('payment_state', '!=', 'partial')]}"
                    />
                    <widget
                        name="web_ribbon"
                        title="Not Paid"
                        bg_color="bg-danger"
                        attrs="{'invisible': [('payment_state', '!=', 'not_paid')]}"
                    />
                    <field name="payment_state" invisible="1" />
                    <div class="oe_title">
                        <span class="o_form_label">Waybill</span>
                        <h1 class="mt0">
                            <field name="name" />
                        </h1>
                    </div>
                    <group name="waybill">
                        <group name="left_waybill">
                            <field
                                name="partner_id"
                                attrs="{'readonly':[('state','in',['confirmed', 'cancel'])]}"
                                widget="res_partner_many2one"
                                context="{'res_partner_search_mode': 'customer', 'show_address': 1, 'show_vat': True}"
                                options="{'no_create': True}"
                            />
                            <field
                                name="partner_order_id"
                                attrs="{'readonly':[('state','in',['confirmed', 'cancel'])]}"
                                domain="[('parent_id','=',partner_id), ('type', '=', 'contact')]"
                                context="{'search_default_customer':1, 'show_address': 1}"
                                options="{'no_create': True, 'no_open': True}"
                            />
                            <field
                                name="invoice_partner_id"
                                attrs="{'readonly':[('state','in',['confirmed', 'cancel'])]}"
                                context="{'search_default_customer':1, 'show_address': 1}"
                                domain="['|', ('id', '=', partner_id), '&amp;', ('parent_id', '=', partner_id), ('type', '=', 'invoice')]"
                                options="{'no_create': True, 'no_open': True}"
                            />
                            <field
                                name="travel_id"
                                attrs="{'readonly':[('state','in',['confirmed', 'cancel'])], 'invisible': [('partner_id', '=', False)]}"
                                domain="[('state', 'not in', ['cancel','closed']), ('partner_ids', 'in', [partner_id])]"
                                options="{'no_create': True}"
                            />
                        </group>
                        <group name="right_waybill">
                            <field name="date" attrs="{'readonly':[('state','in',['confirmed', 'cancel'])]}" />
                            <field name="user_id" attrs="{'readonly':[('state','in',['confirmed', 'cancel'])]}" />
                            <field name="company_id" groups="base.group_multi_company" options="{'no_create': True}" />
                            <field
                                name="currency_id"
                                attrs="{'readonly':[('state','in',['confirmed', 'cancel'])]}"
                                groups="base.group_multi_currency"
                                options="{'no_create': True, 'no_open': True}"
                            />
                        </group>
                    </group>
                    <notebook colspan="4">
                        <page string="Lines" name="lines">
                            <label for="transportable_line_ids" />
                            <field
                                name="transportable_line_ids"
                                attrs="{'readonly':[('state','in',['confirmed', 'cancel'])]}"
                                nolabel="1"
                            >
                                <tree editable="bottom">
                                    <field name="sequence" widget="handle" />
                                    <field name="transportable_id" options="{'no_create': 1}" />
                                    <field name="name" />
                                    <field name="uom_categ_id" invisible="1" />
                                    <field
                                        name="product_uom_id"
                                        options="{'no_create': 1}"
                                        domain="[('category_id', '=', uom_categ_id)]"
                                    />
                                    <field name="quantity" />
                                    <field name="notes" />
                                </tree>
                            </field>
                            <label for="waybill_line_ids" />
                            <field
                                attrs="{'readonly':[('state','in',['confirmed', 'cancel'])]}"
                                name="waybill_line_ids"
                                nolabel="1"
                            >
                                <tree editable="bottom">
                                    <field name="sequence" widget="handle" />
                                    <field name="company_id" invisible="1" />
                                    <field
                                        name="product_id"
                                        domain="[('tms_product_category', 'in', ('freight', 'move', 'insurance', 'tolls', 'other'))]"
                                    />
                                    <field name="name" />
                                    <field name="product_qty" />
                                    <field name="product_uom_id" optional="hide" />
                                    <field
                                        name="analytic_account_id"
                                        groups="analytic.group_analytic_accounting"
                                        optional="hide"
                                    />
                                    <field
                                        name="analytic_tag_ids"
                                        groups="analytic.group_analytic_tags"
                                        widget="many2many_tags"
                                        optional="hide"
                                    />
                                    <field name="price_unit" />
                                    <field name="discount" optional="hide" />
                                    <field name="tax_ids" widget="many2many_tags" />
                                    <field name="amount_untaxed" optional="show" />
                                </tree>
                            </field>
                            <group col="12" class="oe_invoice_lines_tab">
                                <group string="Notes" name="notes" colspan="8">
                                    <field name="notes" nolabel="1" class="oe_inline" placeholder="Notes..." />
                                </group>
                                <group class="oe_subtotal_footer oe_right" name="sale_total" colspan="4">
                                    <field
                                        name="amount_freight"
                                        options="{'currency_field': 'currency_id'}"
                                        widget="monetary"
                                    />
                                    <field
                                        name="amount_move"
                                        options="{'currency_field': 'currency_id'}"
                                        widget="monetary"
                                    />
                                    <field
                                        name="amount_highway_tolls"
                                        options="{'currency_field': 'currency_id'}"
                                        widget="monetary"
                                    />
                                    <field
                                        name="amount_insurance"
                                        options="{'currency_field': 'currency_id'}"
                                        widget="monetary"
                                    />
                                    <field
                                        name="amount_other"
                                        options="{'currency_field': 'currency_id'}"
                                        widget="monetary"
                                    />
                                    <field
                                        name="tax_totals_json"
                                        widget="account-tax-totals-field"
                                        nolabel="1"
                                        colspan="2"
                                    />
                                </group>
                            </group>
                        </page>
                    </notebook>
                </sheet>
                <div class="oe_chatter">
                    <field name="message_follower_ids" widget="mail_followers" />
                    <field name="activity_ids" widget="mail_activity" />
                    <field name="message_ids" widget="mail_thread" />
                </div>
            </form>
        </field>
    </record>
    <record id="view_tms_waybill_filter" model="ir.ui.view">
        <field name="name">tms.waybill.list.select</field>
        <field name="model">tms.waybill</field>
        <field name="arch" type="xml">
            <search string="Search Waybills">
                <field name="name" />
                <field name="partner_id" />
                <field name="date" string="Waybill date" />
                <field name="user_id" />
                <filter name="pending" domain="[('state','=','draft')]" string="Pending" />
                <filter name="confirmed" domain="[('state','=','confirmed')]" string="Confirmed" />
                <filter name="invoiced" domain="[('move_id','!=', False)]" string="Invoiced" />
                <filter name="not_invoiced" domain="[('move_id','=', False)]" string="Not Invoiced" />
                <filter domain="[('state','!=','cancel')]" name="not_cancelled" string="Not Cancelled" />
                <filter
                    domain="[('date','&gt;=', time.strftime('%Y-%m-01'))]"
                    name="this_month"
                    string="From this month"
                />
                <filter name="my_waybills" domain="[('user_id','=',uid)]" string="My Waybills" />
                <filter name="customer" context="{'group_by':'partner_id'}" string="Customer" />
                <filter name="state" context="{'group_by':'state'}" string="State" />
                <filter name="order_date" context="{'group_by':'date'}" string="Order Date" />
                <filter name="salesman" context="{'group_by':'user_id'}" string="Salesman" />
                <filter name="period" context="{'group_by' : 'date'}" string="Period" />
            </search>
        </field>
    </record>
    <record id="view_tms_waybill_calendar" model="ir.ui.view">
        <field name="name">tms.waybill.calendar</field>
        <field name="model">tms.waybill</field>
        <field name="arch" type="xml">
            <calendar color="state" date_start="date" string="Waybills">
                <field name="partner_id" />
                <field name="amount_untaxed" />
            </calendar>
        </field>
    </record>
    <record id="view_tms_waybill_graph" model="ir.ui.view">
        <field name="name">tms.waybill.graph</field>
        <field name="model">tms.waybill</field>
        <field name="arch" type="xml">
            <graph string="Waybill" type="bar">
                <field name="partner_id" />
                <field name="amount_untaxed" operator="+" />
            </graph>
        </field>
    </record>
        <record id="view_tms_waybill_pivot" model="ir.ui.view">
         <field name="name">tms.waybill.pivot</field>
         <field name="model">tms.waybill</field>
         <field name="arch" type="xml">
             <pivot string="Pivot">
                <field name="name" type="row" />
                <field name="date" type="row" />
                <field name="partner_id" type="row" />
                <field name="amount_untaxed" type="measure" />
                <field name="amount_total" type="measure" />
             </pivot>
         </field>
    </record>
    <record id="action_tms_waybill_form" model="ir.actions.act_window">
        <field name="name">Waybills</field>
        <field name="type">ir.actions.act_window</field>
        <field name="res_model">tms.waybill</field>
        <field name="view_mode">tree,form,pivot,calendar,graph</field>
        <field name="search_view_id" ref="view_tms_waybill_filter" />
        <field name="context">{'search_default_user_id':uid, 'search_default_this_month': 1}</field>
        <field name="help">Waybills</field>
    </record>
</odoo>
