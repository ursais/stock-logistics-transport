<?xml version="1.0" encoding="utf-8" ?>
<odoo>
    <record id="view_tms_waybill_tree" model="ir.ui.view">
        <field name="name">tms.waybill.tree</field>
        <field name="model">tms.waybill</field>
        <field name="priority">2</field>
        <field name="arch" type="xml">
            <tree
                decoration-muted="state=='cancel'"
                decoration-danger="state=='draft'"
                decoration-success="state=='approved'"
            >
                <field name="name" />
                <field name="date" />
                <field name="partner_id" />
                <field name="amount_untaxed" sum="Amount Untaxed" />
                <field name="amount_tax" />
                <field name="amount_total" />
                <field invisible="1" name="move_id" />
                <field invisible="1" name="user_id" />
                <field name="state" />
                <button icon="fa-check-square-o" name="action_approve" states="draft" string="Approve" type="object" />
            </tree>
        </field>
    </record>
    <record id="view_tms_waybill_form" model="ir.ui.view">
        <field name="name">tms.waybill.form</field>
        <field name="model">tms.waybill</field>
        <field name="arch" type="xml">
            <form string="Waybill">
                <header>
                    <button
                        class="oe_highlight"
                        icon="fa-check-square-o"
                        name="action_approve"
                        states="draft"
                        string="Approve"
                        type="object"
                    />
                    <button
                        icon="fa-reply"
                        name="action_cancel_draft"
                        states="cancel"
                        string="Set to Draft"
                        type="object"
                    />
                    <button
                        icon="fa-times"
                        name="action_cancel"
                        states="draft,approved,confirmed"
                        string="Cancel"
                        type="object"
                    />
                    <field name="state" statusbar_visible="draft,approved" widget="statusbar" />

                </header>
                <sheet>
                    <div class="oe_button_box" name="button_box">
                        <field name="move_id" invisible="1" />
                        <button
                            name="action_view_invoice"
                            type="object"
                            class="oe_stat_button"
                            icon="fa-pencil-square-o"
                            attrs="{'invisible': [('move_id', '=', False)]}"
                        >
                            <div class="o_field_widget o_stat_info">
                                <span class="o_stat_text">View Invoice</span>
                            </div>
                        </button>
                    </div>
                    <div class="oe_title">
                        <span class="o_form_label">Waybill</span>
                        <h1 class="mt0">
                            <field name="name" />
                        </h1>
                    </div>
                    <group>
                        <group>
                            <field
                                name="partner_id"
                                attrs="{'readonly':[('state','in',['approved', 'cancel'])]}"
                                widget="res_partner_many2one"
                                context="{'res_partner_search_mode': 'customer', 'show_address': 1, 'show_vat': True}"
                                options="{'no_create': True}"
                            />
                            <field
                                name="partner_order_id"
                                attrs="{'readonly':[('state','in',['approved', 'cancel'])]}"
                                domain="[('parent_id','=',partner_id), ('type', '=', 'contact')]"
                                context="{'search_default_customer':1, 'show_address': 1}"
                                options="{'no_create': True, 'no_open': True}"
                            />
                            <field
                                name="invoice_partner_id"
                                attrs="{'readonly':[('state','in',['approved', 'cancel'])]}"
                                context="{'search_default_customer':1, 'show_address': 1}"
                                domain="['|', ('id', '=', partner_id), '&amp;', ('parent_id', '=', partner_id), ('type', '=', 'invoice')]"
                                options="{'no_create': True, 'no_open': True}"
                            />
                        </group>
                        <group>
                            <field name="date" attrs="{'readonly':[('state','in',['approved', 'cancel'])]}" />
                            <field
                                name="currency_id"
                                attrs="{'readonly':[('state','in',['approved', 'cancel'])]}"
                                groups="base.group_multi_currency"
                                options="{'no_create': True, 'no_open': True}"
                            />
                        </group>
                    </group>
                    <notebook colspan="4">
                        <page string="Lines" name="lines">
                            <group>
                                <label for="travel_ids" />
                                <field
                                    name="travel_ids"
                                    attrs="{'readonly':[('state','in',['approved', 'cancel'])]}"
                                    domain="[('state', 'not in', ['cancel','closed']), ('partner_ids', 'in', [partner_id])]"
                                    nolabel="1"
                                />
                                <label for="transportable_line_ids" />
                                <field
                                    name="transportable_line_ids"
                                    attrs="{'readonly':[('state','in',['approved', 'cancel'])]}"
                                    nolabel="1"
                                >
                                    <tree editable="bottom">
                                        <field name="sequence" widget="handle" />
                                        <field name="transportable_id" />
                                        <field name="name" />
                                        <field name="transportable_uom_id" />
                                        <field name="quantity" />
                                        <field name="notes" />
                                    </tree>
                                </field>
                                <label for="waybill_line_ids" />
                                <field
                                    attrs="{'readonly':[('state','in',['approved', 'cancel'])]}"
                                    name="waybill_line_ids"
                                    nolabel="1"
                                >
                                    <tree editable="bottom">
                                        <field
                                            name="product_id"
                                            domain="[('tms_product_category', 'in', ('freight', 'move', 'insurance', 'tolls', 'other'))]"
                                        />
                                        <field name="name" />
                                        <field name="product_qty" />
                                        <field name="product_uom_id" optional="hide" />
                                        <field name="unit_price" />
                                        <field name="discount" optional="hide" />
                                        <field name="tax_ids" widget="many2many_tags" />
                                        <field name="amount_untaxed" optional="hide" />
                                    </tree>
                                </field>
                                <group class="oe_subtotal_footer oe_right" name="sale_total">
                                    <field
                                        name="amount_freight"
                                        options="{'currency_field': 'currency_id'}"
                                        widget="monetary"
                                    />
                                    <field
                                        name="amount_move"
                                        options="{'currency_field': 'currency_id'}"
                                        widget="monetary"
                                    />
                                    <field
                                        name="amount_highway_tolls"
                                        options="{'currency_field': 'currency_id'}"
                                        widget="monetary"
                                    />
                                    <field
                                        name="amount_insurance"
                                        options="{'currency_field': 'currency_id'}"
                                        widget="monetary"
                                    />
                                    <field
                                        name="amount_other"
                                        options="{'currency_field': 'currency_id'}"
                                        widget="monetary"
                                    />
                                    <field
                                        name="tax_totals_json"
                                        widget="account-tax-totals-field"
                                        nolabel="1"
                                        colspan="2"
                                    />
                                </group>
                            </group>
                        </page>
                        <page string="Notes" name="notes">
                            <field name="notes" nolabel="1" placeholder="Notes..." />
                        </page>
                    </notebook>
                </sheet>
                <div class="oe_chatter">
                    <field name="message_follower_ids" widget="mail_followers" />
                    <field name="activity_ids" widget="mail_activity" />
                    <field name="message_ids" widget="mail_thread" />
                </div>
            </form>
        </field>
    </record>
    <record id="view_tms_waybill_filter" model="ir.ui.view">
        <field name="name">tms.waybill.list.select</field>
        <field name="model">tms.waybill</field>
        <field name="arch" type="xml">
            <search string="Search Waybills">
                <field name="name" />
                <field name="partner_id" />
                <field name="date" string="Waybill date" />
                <field name="user_id" />
                <filter name="pending" domain="[('state','=','draft')]" string="Pending" />
                <filter name="approved" domain="[('state','=','approved')]" string="Approved" />
                <filter name="invoiced" domain="[('move_id','!=', False)]" string="Invoiced" />
                <filter name="not_invoiced" domain="[('move_id','=', False)]" string="Not Invoiced" />
                <filter domain="[('state','!=','cancel')]" name="not_cancelled" string="Not Cancelled" />
                <filter
                    domain="[('date','&gt;=', time.strftime('%Y-%m-01'))]"
                    name="this_month"
                    string="From this month"
                />
                <filter name="my_waybills" domain="[('user_id','=',uid)]" string="My Waybills" />
                <filter name="customer" context="{'group_by':'partner_id'}" string="Customer" />
                <filter name="state" context="{'group_by':'state'}" string="State" />
                <filter name="order_date" context="{'group_by':'date'}" string="Order Date" />
                <filter name="salesman" context="{'group_by':'user_id'}" string="Salesman" />
                <filter name="period" context="{'group_by' : 'date'}" string="Period" />
            </search>
        </field>
    </record>
    <record id="view_tms_waybill_calendar" model="ir.ui.view">
        <field name="name">tms.waybill.calendar</field>
        <field name="model">tms.waybill</field>
        <field name="arch" type="xml">
            <calendar color="state" date_start="date" string="Waybills">
                <field name="partner_id" />
                <field name="amount_untaxed" />
            </calendar>
        </field>
    </record>
    <record id="view_tms_waybill_graph" model="ir.ui.view">
        <field name="name">tms.waybill.graph</field>
        <field name="model">tms.waybill</field>
        <field name="arch" type="xml">
            <graph string="Waybill" type="bar">
                <field name="partner_id" />
                <field name="amount_untaxed" operator="+" />
            </graph>
        </field>
    </record>
        <record id="view_tms_waybill_pivot" model="ir.ui.view">
         <field name="name">tms.waybill.pivot</field>
         <field name="model">tms.waybill</field>
         <field name="arch" type="xml">
             <pivot string="Pivot">
                <field name="name" type="row" />
                <field name="date" type="row" />
                <field name="partner_id" type="row" />
                <field name="amount_untaxed" type="measure" />
                <field name="amount_total" type="measure" />
             </pivot>
         </field>
    </record>
    <record id="action_tms_waybill_form" model="ir.actions.act_window">
        <field name="name">Waybills</field>
        <field name="type">ir.actions.act_window</field>
        <field name="res_model">tms.waybill</field>
        <field name="view_mode">tree,form,pivot,calendar,graph</field>
        <field name="search_view_id" ref="view_tms_waybill_filter" />
        <field name="context">{'search_default_user_id':uid, 'search_default_this_month': 1}</field>
        <field name="help">Waybills</field>
    </record>
</odoo>
